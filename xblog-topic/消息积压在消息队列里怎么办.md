---
submitToken: 868F31D11B3B125E9F9E05BD9D6782E67012AFF65FADF4355D07FA22E38E3418
title: 消息积压在消息队列里怎么办
channel: topic
labels: mq
---

场景：几千万条数据在MQ里积压了七八个小时，从下午4点多，积压到了晚上很晚，10点多，11点多。线上故障了，这个时候要不然就是修复consumer的问题，让他恢复消费速度，然后傻傻的等待几个小时消费完毕。这个肯定不行。一个消费者一秒是1000条，一秒3个消费者是3000条，一分钟是18万条，1000多万条。
所以如果你积压了几百万到上千万的数据，即使消费者恢复了，也需要大概1小时的时间才能恢复过来。
## 解决方案：

这种时候只能操作临时扩容，以更快的速度去消费数据了。具体操作步骤和思路如下：

> ①先修复consumer的问题，确保其恢复消费速度，然后将现有consumer都停掉。

> ②临时建立好原先10倍或者20倍的queue数量(新建一个topic，partition是原来的10倍)。

> ③然后写一个临时分发消息的consumer程序，这个程序部署上去消费积压的消息，消费之后不做耗时处理，直接均匀轮询写入临时建好分10数量的queue里面。

> ④紧接着征用10倍的机器来部署consumer，每一批consumer消费一个临时queue的消息。

> ⑤这种做法相当于临时将queue资源和consumer资源扩大10倍，以正常速度的10倍来消费消息。

> ⑥等快速消费完了之后，恢复原来的部署架构，重新用原来的consumer机器来消费消息。

