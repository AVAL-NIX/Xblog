---
submitToken: 6B18475708E2EB2ECCA2CDB167A97F80B798E0C89EBE0849C1F00046C2E6567C
title: 什么是 MVCC？
channel: topic
labels: 数据库
---

> 多版本并发控制（Multi-Version Concurrency Control, MVCC），MVCC在每行记录后面都保存有两个隐藏的列，用来存储**创建版本号**和**删除版本号**。

- **创建版本号**：创建一个数据行时的事务版本号（**事务版本号**：事务开始时的系统版本号；系统版本号：每开始一个新的事务，系统版本号就会自动递增）；

- **删除版本号**：删除操作时的事务版本号；

- ## 各种操作：
    - **插入操作时**，记录创建版本号；
    - **删除操作时**，记录删除版本号；
    - **更新操作时**，先记录删除版本号，再新增一行记录创建版本号；
    - **查询操作时**，要符合以下条件才能被查询出来：删除版本号未定义或大于当前事务版本号（删除操作是在当前事务启动之后做的）；创建版本号小于或等于当前事务版本号（创建操作是事务完成或者在事务启动之前完成）

通过版本号减少了锁的争用，**提高了系统性能**；可以实现**提交读**和**可重复读**两种隔离级别，未提交读无需使用MVCC

## 快照读与当前读

- 使用 MVCC 读取的是快照中的数据，这样可以减少加锁所带来的开销：

```
select * from table ...;
```

- 当前读读取的是最新的数据，需要加锁。以下第一个语句需要加 S 锁，其它都需要加 X 锁：

```
select * from table where ? lock in share mode;
select * from table where ? for update;
insert;
update;
delete;
```