---
submitToken: 4B63FDFEEEB54F832B0CE25AB4DCD925FB1DC4156F22BB37D69ED59F4F03D626
title: Redis Cluser是如何保证HA的?
channel: topic
labels: redis
---


　　Redis Cluster保证高可用主要还是依靠：故障检测与故障转移两种策略，这其实很多分布式集群都能保证，但是针对Redis Cluster有一些细节需要好好学习并理解。

## 故障转移(其实就是从节点升级)


（2）故障转移具体流程：
　　当一个从节点发现自己正在复制的主节点下线时，从节点将开始对下线主节点进行故障转移：

　　1） 在该下线主节点的所有从节点中，选择一个做主节点

　　2） 被选中的从节点会执行SLAVEOF no one命令，成为新的主节点；

　　3） 新的主节点会撤销对所有对已下线主节点的槽指派，并将这些槽全部派给自己。

　　4） 新的主节点向集群广播一条PONG消息，让其他节点知道“我已经变成主节点了，并且我会接管已下线节点负责的处理的槽”；

　　5） 新主节点开始接收和自己负责处理的槽有关的命令请求，故障转移完成。

（3）选举新节点
　　1）集群配置纪元是一个自增计数器，它的初始值为0；

　　2）当集群里的某个节点开始一次故障转移时，集群配置纪元的值会被增加1

　　3）对于每个配置纪元，集群里的每个负责处理槽的主节点都有一次投票的机会，而第一个向主节点要求投票的从节点将获得主节点的投票。

　　4）当从节点发现自己正在复制的主节点进入已下线状态时，从节点会向集群广播消息：要求所有收到这条消息、并且具有投票权的主节点向这个从节点投票。

　　5）如果一个主节点具有投票权，并且这个主节点尚未投票跟其它从节点，那么主节点将要求投票的从节点返回一条ACK消息，表示支持该从节点成为新的主节点。

　　6）每个主节点只有一次投票机会，所有有N个主节点的话，那么具有大于N/2+1张支持票的从节点只有一个。

　　7）如果在一个配置纪元里没有从节点能收集到足够多的支持票，那么集群进入一个新的配置纪元，并再次进行选举，直到选出新的主节点为止。

## 故障检测（就是不停的PING）


　集群中每个节点都会定期地向集群中的其他节点发送PING消息，以此检测对方是否在线；如果接收PING消息的节点没有在规定的时间内，向发送PING消息的节点返回PONG消息，那么发送PING消息的节点就会将PING消息节点标记为疑似下线（possible fail，PFAIL）。
![](https://image.avalon-zheng.xin/e3e29e2b-9660-4a93-a074-321454c4728b "")


　　如果在集群中，超过半数以上负责处理槽的主节点都将某个节点X标记为PFAIL，则某个主节点就会将这个主节点X就会被标记为已下线（FAIL），并且广播到这条消息，这样其他所有的节点都会立即将主节点X标记为FAIL。

