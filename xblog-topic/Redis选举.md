---
submitToken: 608989D04447A6C54C4DE70C0C28461174B7C945CCD9340338703D0B6F244322
title: Redis选举机制
channel: topic
labels: juc
---

### raft算法

**Sentinel（哨兵）是Redis实现高可用的保证**。Sentinel系统作用就是监视Redis服务器集群，它可以不停的获得redis集群状态，当一个主节点挂了，故障转移操作会在从节点中选出一个新的主节点，这里故障转移就是由Sentinel来主导完成的。
不要把Sentinel想的太复杂，**它其实就是一个特殊工作模式的Redis服务器**而已，Redis是集群部署的，这里的Sentinel也是要集群部署的，要是非单点部署，你的Sentinel挂了，此时的Redis集群就GG了。
接着上边说，当主服务器节点挂了，Sentinel系统就会选出一个**领头的Sentinel**来完成故障转移工作。选举规则如下: - 监视这个挂了的主节点的所有Sentinel都有被选举为领头的资格

- **每进行一次选举，不论是否成功，配置纪元+1**，配置纪元就是个计数器

- 每个Sentinel在**每个配置纪元中有且仅有一次选举机会**，一旦选好了该节点认为的主节点，在这个纪元内，不可以再更改

- 每个发现服务器挂了的Sentinel都会配置纪元+1并投自己一票，接着发消息要求其他Sentinel设置自己为领头人1，**每个Sentinel都想成为领头的**

- 每个Sentinel会将最先发来请求领头的节点设为自己的领头节点并发送回复，**谁先来我选谁**

- 当源Sentinel收到回复，并且**回复中的配置纪元和自己的一致且领头Id是自己的Sentinel** Id时，表明目标Sentinel已经将自己设为领头

- 在一个配置纪元内，当某个Sentinel收到半数以上的同意回复时，它就是领头的了

- 如果在给定时间内，没有被成功选举的Sentinel，那么过段时间发起新的选举


选举领头Sentinel的过程和规则大概就如上所述，需要注意的是只有集群出现节点挂了才需要选举出领头Sentinel，平时每个Sentinel还是平等身份~
这里的选举其实是raft算法的一个应用，有兴趣的小伙伴可以去读下这篇算法的论文

### cluster

1）集群配置纪元是一个自增计数器，它的初始值为0；

　　2）当集群里的某个节点开始一次故障转移时，集群配置纪元的值会被增加1

　　3）对于每个配置纪元，集群里的每个负责处理槽的主节点都有一次投票的机会，而第一个向主节点要求投票的从节点将获得主节点的投票。

　　4）当从节点发现自己正在复制的主节点进入已下线状态时，从节点会向集群广播消息：要求所有收到这条消息、并且具有投票权的主节点向这个从节点投票。

　　5）如果一个主节点具有投票权，并且这个主节点尚未投票跟其它从节点，那么主节点将要求投票的从节点返回一条ACK消息，表示支持该从节点成为新的主节点。

　　6）每个主节点只有一次投票机会，所有有N个主节点的话，那么具有大于N/2+1张支持票的从节点只有一个。

　　7）如果在一个配置纪元里没有从节点能收集到足够多的支持票，那么集群进入一个新的配置纪元，并再次进行选举，直到选出新的主节点为止。
